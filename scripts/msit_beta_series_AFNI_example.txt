#! /bin/csh
#use different script for 027
set subjs = (001 002 003 004 005 007 010 011 014 015 017 018 020 022 024 026 031 032 033 034 038 039 044 046 048 049 053 054 057 059 060 062 063 067 070 071 073 075 076 077 080 081 201 202 203 207 208 209 210 215 216 217 218 219 222 223 224 225 226 228 229 230 231 233 234 236 238 239 240 244 247 249 250 253 256 261 265 266 267 268 270 271 273 282 284 285 287 288 290 291)

set study = DOP

cd /Volumes/Vol2/cisler/DOP/

set rootpth = `pwd`

foreach subj (${subjs})

	cd ${rootpth}
	cd ${subj}/day1/FCT/

	set activeSubjectdirectory = `pwd`

	echo activeSubjectdirectory
		

				echo -------------------------------------------------------------------------------
				echo 3dDeconvolve FCT task
				echo -------------------------------------------------------------------------------

				rm ${activeSubjectdirectory}/analyze/FCT.LSS.xmat.1D
				rm ${activeSubjectdirectory}/analyze/FCT.LSS.${subj}.nii
				
				rm censor_file
				1dtranspose ${activeSubjectdirectory}/run1/${study}.${subj}.FCT.run1.censor.1D > ./run1_t
				1dtranspose ${activeSubjectdirectory}/run2/${study}.${subj}.FCT.run2.censor.1D > ./run2_t
				1dcat run1_t run2_t > cat_file
				1dtranspose cat_file > censor_file

				1dMarry ./analyze/${subj}.rating_times.txt ./analyze/${subj}.rating_length.txt > ./analyze/${subj}.rating_time_x_length.txt


				
			3dDeconvolve -force_TR 2 \
					-input ${activeSubjectdirectory}/run1/DOP.${subj}.FCT.run1.scaled.resid_UAMS_size.nii ${activeSubjectdirectory}/run2/DOP.${subj}.FCT.run2.scaled.resid_UAMS_size.nii \
					-nfirst 0 \
					-censor ${activeSubjectdirectory}/censor_file \
					-polort A \
					-num_stimts 3 \
					-stim_times_IM 1 ${activeSubjectdirectory}/analyze/${subj}.stims_in_raw_orders.txt 'BLOCK(3,1)' -stim_label 1 CS_presentation \
					-stim_times 2 ${activeSubjectdirectory}/analyze/${subj}.shock.txt 'BLOCK(3,1)' -stim_label 2 shock \
					-stim_times_AM1 3 ${activeSubjectdirectory}/analyze/${subj}.rating_time_x_length.txt 'dmBLOCK(1)' -stim_label 3 rating \
					-x1D ${activeSubjectdirectory}/analyze/FCT.LSS.xmat.1D \
					-allzero_OK \
					-nobucket \
					-x1D_stop

				rm concat_runs*
				3dTcat -prefix concat_runs ${activeSubjectdirectory}/run1/DOP.${subj}.FCT.run1.scaled.resid_UAMS_size.nii ${activeSubjectdirectory}/run2/DOP.${subj}.FCT.run2.scaled.resid_UAMS_size.nii

				3dLSS -input concat_runs+tlrc \
					-matrix ${activeSubjectdirectory}/analyze/FCT.LSS.xmat.1D \
					-prefix ${activeSubjectdirectory}/analyze/FCT.LSS.${subj}.nii

				#go ahead and despike right away
				echo 'here'
				rm ${activeSubjectdirectory}/analyze/FCT.LSS.${subj}_despike.nii
				3dDespike -prefix ${activeSubjectdirectory}/analyze/FCT.LSS.${subj}_despike.nii \
					${activeSubjectdirectory}/analyze/FCT.LSS.${subj}.nii
				

				cd ${activeSubjectdirectory}

				chmod -R -f ug+rw .


end

